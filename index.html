<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏≠‡∏û‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#0b74ff;
      --accent-600:#065fd6;
      --success:#07a981;
      --danger:#dc3545;
      --radius:12px;
      --max-width:1160px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body { font-family: 'Noto Sans Thai', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:var(--bg); margin:0; color:#111; }
    .site { max-width:var(--max-width); margin:28px auto; padding:20px; }

    header.topbar{display:flex;align-items:center;gap:16px;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;background:linear-gradient(135deg,var(--accent),#8ab6ff);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px}
    .brand h1{margin:0;font-size:18px}

    .controls{display:flex;gap:12px;align-items:center}
    .search{display:flex;gap:8px;align-items:center;background:var(--card);padding:8px;border-radius:999px;box-shadow:0 2px 6px rgba(16,24,40,0.04)}
    .search input{border:0;background:transparent;outline:none;padding:6px 8px;font-size:15px;width:260px}
    .select{background:var(--card);padding:8px;border-radius:10px;box-shadow:0 2px 6px rgba(16,24,40,0.04)}

    .cart-summary{background:linear-gradient(180deg,var(--accent),var(--accent-600));color:#fff;padding:8px 12px;border-radius:10px;display:flex;gap:12px;align-items:center}
    .cart-summary .count{font-weight:700}

    main{display:grid;grid-template-columns:1fr;gap:18px}

    .panel{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 6px 20px rgba(11,20,40,0.04)}
    .panel h2{margin:0 0 12px;font-size:16px}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:18px}
    .card{background:linear-gradient(180deg,#ffffff,#fbfdff);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(11,20,40,0.04);display:flex;flex-direction:column;gap:8px}
    .card .img{width:100%;height:160px;border-radius:10px;overflow:hidden}
    .card .img img{width:100%;height:100%;object-fit:cover;display:block}
    .card h3{margin:4px 0 0;font-size:16px}
    .meta{font-size:13px;color:var(--muted)}
    .price{color:var(--success);font-weight:700;font-size:16px}
    .card .actions{margin-top:auto;display:flex;gap:8px}
    .btn{border:0;padding:9px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-ghost{background:#f3f4f6;color:#111}

    /* side cart */
    .cart-panel{position:fixed;right:20px;top:20px;width:360px;max-width:calc(100% - 40px);height:86vh;background:var(--card);border-radius:14px;box-shadow:0 12px 40px rgba(11,20,40,0.12);padding:16px;overflow:auto;display:none;z-index:999}
    .cart-item{display:flex;gap:10px;align-items:center;padding:10px 0;border-bottom:1px solid #f0f2f5}
    .cart-item img{width:64px;height:64px;object-fit:cover;border-radius:8px}

    .popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;z-index:10000}

    @media (max-width:900px){
      .controls{flex-direction:column;align-items:flex-start}
      .search input{width:160px}
      .grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
      .cart-panel{right:12px;left:12px;width:auto;height:72vh}
    }
  </style>
</head>
<body>
  <div class="site">
    <header class="topbar">
      <div class="brand">
        <div class="logo">‡∏£‡πâ‡∏≤‡∏ô</div>
        <div>
          <h1>‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏≠‡∏û‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
          <div style="font-size:12px;color:var(--muted)">‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‚Äî ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
        </div>
      </div>

      <div class="controls">
        <div class="search">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M21 21l-4.35-4.35" stroke="#9aa4b2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="#9aa4b2" stroke-width="2"/></svg>
          <input id="search" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." oninput="renderProducts()">
        </div>
        <div class="select">
          <select id="categoryFilter" onchange="renderProducts()">
            <option value="all">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
            <option value="it">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå IT</option>
            <option value="tools">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡πà‡∏≤‡∏á</option>
            <option value="fashion">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ / ‡πÅ‡∏ß‡πà‡∏ô‡∏ï‡∏≤</option>
          </select>
        </div>
        <div class="cart-summary" role="button" onclick="toggleCart()" style="cursor:pointer">
          <div>üõí</div>
          <div style="font-size:13px">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ <span class="count" id="cartCount">0</span></div>
          <div style="font-size:13px">‡∏ø<span id="cartTotal">0</span></div>
        </div>
      </div>
    </header>

    <main>
      <section class="panel" aria-labelledby="order-check">
        <h2 id="order-check">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="checkName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á" style="flex:1;min-width:180px;padding:8px;border-radius:8px;border:1px solid #eef2f7" />
          <input id="checkPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" style="flex:1;min-width:150px;padding:8px;border-radius:8px;border:1px solid #eef2f7" />
          <button class="btn btn-primary" onclick="checkOrder()">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
        </div>
        <div id="orderResult" style="margin-top:12px;color:var(--muted)"></div>
      </section>

      <section class="panel">
        <div class="grid" id="productGrid"></div>
      </section>
    </main>
  </div>

  <aside class="cart-panel" id="cartBox" aria-hidden="true">
    <h2>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
    <div id="cartItems"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div style="font-weight:700">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      <div style="font-weight:700">‡∏ø<span id="cartTotalBox">0</span></div>
    </div>

    <div style="margin-top:12px">
      <input id="customerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á" style="width:100%; margin-bottom:8px; padding:8px; border-radius:8px; border:1px solid #eef2f7;" />
      <input id="customerPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" style="width:100%; margin-bottom:8px; padding:8px; border-radius:8px; border:1px solid #eef2f7;" />
      <textarea id="customerAddress" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" style="width:100%;min-height:80px;padding:8px;border-radius:8px;border:1px solid #eef2f7"></textarea>

      <div style="margin-top:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <label><input type="radio" name="delivery" value="delivery" checked onchange="togglePickup(false)"> ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
        <label><input type="radio" name="delivery" value="pickup" onchange="togglePickup(true)"> ‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô</label>
      </div>

      <div id="paymentBox" style="margin-top:8px;">
        <label><input type="radio" name="payment" value="transfer" checked onchange="toggleSlip(true)"> ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
        <input type="file" id="slipFile" accept="image/*" style="display:block; margin-top:6px;" />
      </div>

      <div id="pickupBox" style="display:none; margin-top:8px;">
        <select id="pickupBranch" required style="width:100%; margin-bottom:5px;padding:8px;border-radius:8px;border:1px solid #eef2f7;">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á --</option>
          <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏Å‡∏•">‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏Å‡∏•</option>
          <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£">‡∏™‡∏≤‡∏Ç‡∏≤‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£</option>
          <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏•‡∏¥‡∏á‡∏ô‡∏Å‡∏ó‡∏≤">‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏•‡∏¥‡∏á‡∏ô‡∏Å‡∏ó‡∏≤</option>
          <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏≤‡πÅ‡∏Å">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏≤‡πÅ‡∏Å</option>
          <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç">‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç</option>
        </select>
        <input id="pickupDate" type="date" required style="width:100%;margin-bottom:6px;padding:8px;border-radius:8px;border:1px solid #eef2f7" />
        <input id="pickupTime" type="time" required style="width:100%;padding:8px;border-radius:8px;border:1px solid #eef2f7" />
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn btn-primary" onclick="submitOrder()" style="flex:1">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
      <button class="btn btn-ghost" onclick="toggleCart()" style="flex:1">‡∏õ‡∏¥‡∏î</button>
    </div>
  </aside>

  <div class="popup-overlay" id="successPopup">
    <div style="background:#fff;border-radius:12px;padding:20px;max-width:420px;width:90%;text-align:center">
      <h2 style="margin:0 0 8px;color:var(--success)">‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h2>
      <div id="popupDetail" style="color:var(--muted)"></div>
      <div style="margin-top:12px"><button class="btn btn-primary" onclick="closePopup()">‡∏ï‡∏Å‡∏•‡∏á</button></div>
    </div>
  </div>

  <div class="popup-overlay" id="imageViewer" onclick="closeImageViewer()">
    <button onclick="closeImageViewer(); event.stopPropagation()" style="position:absolute;top:20px;right:20px;font-size:28px;background:#000a;border:none;color:#fff;border-radius:50%;width:44px;height:44px;cursor:pointer">‚úï</button>
    <img id="viewerImg" style="max-width:90%;max-height:90%;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.4)" />
  </div>

  <!-- Slider ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ -->
  <div class="popup-overlay" id="imageSlider" onclick="closeSlider()" style="display:none;">
    <button onclick="closeSlider(); event.stopPropagation()" style="position:absolute;top:20px;right:20px;font-size:28px;background:#000a;border:none;color:#fff;border-radius:50%;width:44px;height:44px;cursor:pointer">‚úï</button>
    <button onclick="prevSlide(event)" style="position:absolute;left:20px;font-size:32px;background:none;border:none;color:#fff">‚ùÆ</button>
    <img id="sliderImg" style="max-width:90%;max-height:90%;border-radius:10px;" />
    <button onclick="nextSlide(event)" style="position:absolute;right:20px;font-size:32px;background:none;border:none;color:#fff">‚ùØ</button>
  </div>

  <div class="popup-overlay" id="detailPopup" style="display:none;">
    <div style="background:#fff;border-radius:12px;padding:16px;max-width:720px;width:92%;text-align:left;" onclick="event.stopPropagation()">
      <div id="detailBox"></div>
      <div style="display:flex;gap:10px;margin-top:12px;"><button onclick="buyNow(currentDetailId)" style="flex:1;" class="btn btn-primary">üõí ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button><button onclick="closeDetail()" style="flex:1;background:#6c757d;color:#fff;border-radius:8px;border:0;padding:9px">‡∏õ‡∏¥‡∏î</button></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    function togglePickup(isPickup) {
      document.getElementById('pickupBox').style.display = isPickup ? 'block' : 'none';
      document.getElementById('paymentBox').style.display = isPickup ? 'none' : 'block';
      document.getElementById('customerAddress').disabled = isPickup;
    }
    function toggleSlip(show) {
      document.getElementById('slipFile').style.display = show ? 'block' : 'none';
    }

    const SUPABASE_URL = 'https://dfeaeyywbaywrvnudgvu.supabase.co';
    const SUPABASE_KEY = 'sb_publishable__mJEVWqu--G3YVxgOdKAng_N985StDd';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ===== state =====
let products = [];
let cart = [];

// ===== ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ =====
async function loadProducts(){
  const { data, error } = await supabaseClient.from('products').select('*');
  if(error){ console.error(error); return; }
  products = data || [];
  renderProducts();
}

function renderProducts(){
  const grid = document.getElementById('productGrid');
  const category = document.getElementById('categoryFilter').value;
  const search = (document.getElementById('search').value || '').toLowerCase();
  grid.innerHTML = '';

  products
    .filter(p => (p.stock ?? 0) > 0) // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏ï‡πá‡∏≠‡∏Å = 0
    .filter(p => category === 'all' || p.category === category)
    .filter(p => (p.name || '').toLowerCase().includes(search) || (p.brand || '').toLowerCase().includes(search))
    .forEach(p => {
      const card = document.createElement('div');
      card.className = 'card';
      const cover = (p.image_urls && p.image_urls[0]) || 'https://via.placeholder.com/300x200';
      card.innerHTML = `
        <div class="img"><img src="${cover}" onclick="openSlider('${p.id}')" alt="${(p.name||'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤')}"/></div>
        <h3>${p.name}</h3>
        <div class="meta">‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå: ${p.brand || '-'}</div>
        <div class="meta" style="font-size:13px;color:var(--muted)">${p.specs || ''}</div>
        <div class="price">‡∏ø${Number(p.price).toLocaleString()}</div>
        <div class="meta">‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${p.stock ?? '-'} ‡∏ä‡∏¥‡πâ‡∏ô</div>
        <div class="actions"><button class="btn btn-primary" onclick="buyNow('${p.id}')">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button><button class="btn btn-ghost" onclick="openDetail('${p.id}')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></div>`;
      grid.appendChild(card);
    });
}

    function buyNow(id) {
      const product = products.find(p => p.id === id);
      if (!product || product.stock <= 0) {
        alert('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å');
        return;
      }

      const item = cart.find(i => i.id === id);
      if (item) {
        if (item.qty + 1 > product.stock) {
          alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å');
          return;
        }
        item.qty += 1;
      } else {
        cart.push({ ...product, qty: 1 });
      }

      updateCart();

      // ‚úÖ ‡∏õ‡∏¥‡∏î popup ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà)
      const detailPopup = document.getElementById('detailPopup');
      if (detailPopup) detailPopup.style.display = 'none';

      // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ + ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å
      const cartBox = document.getElementById('cartBox');
      cartBox.style.display = 'block';
      cartBox.scrollTop = 0;

      setTimeout(() => {
        const nameInput = document.getElementById('customerName');
        if (nameInput) nameInput.focus();
      }, 50);
    }

    function removeFromCart(id) {
      cart = cart.filter(i => i.id !== id);
      updateCart();
    }

    function updateCart() {
      const count = cart.reduce((s, i) => s + i.qty, 0);
      const total = cart.reduce((s, i) => s + i.qty * i.price, 0);
      document.getElementById('cartCount').innerText = count;
      // keep compatibility if floating count exists
      const floating = document.getElementById('floatingCartCount');
      if(floating) floating.innerText = count;
      document.getElementById('cartTotal').innerText = total.toLocaleString();
      document.getElementById('cartTotalBox').innerText = total.toLocaleString();

      const box = document.getElementById('cartItems');
      box.innerHTML = '';
      cart.forEach(i => {
        const img = (i.image_urls && i.image_urls[0]) || 'https://via.placeholder.com/120';
        box.innerHTML += `<div class="cart-item"><img src="${img}" alt="${i.name}"/><div style="flex:1"><div style="font-weight:600">${i.name}</div><div style="font-size:13px;color:var(--muted)">‡∏ø${(i.price*i.qty).toLocaleString()} ‚Ä¢ x${i.qty}</div></div><div><button onclick="removeFromCart('${i.id}')" style="background:${'var(--danger)'};color:#fff;border:0;padding:6px 8px;border-radius:6px;cursor:pointer">‡∏•‡∏ö</button></div></div>`;
      });
    }

    function toggleCart() {
      const box = document.getElementById('cartBox');
      box.style.display = box.style.display === 'block' ? 'none' : 'block';
    }

    async function checkOrder() {
      const name = document.getElementById('checkName').value.trim();
      const phone = document.getElementById('checkPhone').value.trim();
      const box = document.getElementById('orderResult');
      box.innerHTML = '';

      if (!name || !phone) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£');
        return;
      }

      const { data, error } = await supabaseClient
        .from('orders')
        .select('id, total_amount, created_at')
        .eq('customer_name', name)
        .eq('customer_phone', phone)
        .order('created_at', { ascending: false });

      if (error) {
        console.error(error.message || error);
        box.innerHTML = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
        return;
      }

      if (!data || data.length === 0) {
        box.innerHTML = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠';
        return;
      }

      box.innerHTML = data.map(o => `
        <div style="border-bottom:1px solid #eee; padding:8px 0;">
          <div>‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: ${o.id}</div>
          <div>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ‡∏ø${Number(o.total_amount).toLocaleString()}</div>
          <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
          <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(o.created_at).toLocaleString()}</div>
        </div>
      `).join('');
    }

    async function submitOrder() {
      if (cart.length === 0) {
        alert('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á');
        return;
      }

      const customer_name = document.getElementById('customerName').value.trim();
      const customer_phone = document.getElementById('customerPhone').value.trim();
      const customer_address = document.getElementById('customerAddress').value.trim();

      if (!customer_name || !customer_phone) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£');
        return;
      }

      const delivery_type = document.querySelector('input[name="delivery"]:checked').value;
      const payment_type = delivery_type === 'delivery' ? 'transfer' : null;

      let slip_url = null;
      if (payment_type === 'transfer') {
        const file = document.getElementById('slipFile').files[0];
        if (!file) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô');
          return;
        }

        const filePath = `slips/${Date.now()}_${file.name}`;
        const { error: uploadError } = await supabaseClient.storage.from('slips').upload(filePath, file);
        if (uploadError) {
          console.error(uploadError.message || uploadError);
          alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          return;
        }
        slip_url = `${SUPABASE_URL}/storage/v1/object/public/slips/${filePath}`;
      }

      const pickup_branch = delivery_type === 'pickup' ? document.getElementById('pickupBranch').value : null;
      const pickup_date = delivery_type === 'pickup' ? document.getElementById('pickupDate').value : null;
      const pickup_time = delivery_type === 'pickup' ? document.getElementById('pickupTime').value : null;

      if (delivery_type === 'pickup') {
        if (!pickup_branch) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á');
          document.getElementById('pickupBranch').focus();
          return;
        }
        if (!pickup_date) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á');
          document.getElementById('pickupDate').focus();
          return;
        }
        if (!pickup_time) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á');
          document.getElementById('pickupTime').focus();
          return;
        }
      }

      const total_amount = cart.reduce((s, i) => s + i.qty * i.price, 0);

      const { data: order, error } = await supabaseClient
        .from('orders')
        .insert([{ customer_name, customer_phone, customer_address: delivery_type === 'delivery' ? customer_address : null, delivery_type, payment_type, pickup_branch, pickup_date, pickup_time, slip_url, total_amount }])
        .select()
        .single();

      if (error) {
        console.error(error.message || error);
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        return;
      }

      const items = cart.map(i => ({ order_id: order.id, product_id: i.id, product_name: i.name, price: i.price, qty: i.qty, subtotal: i.qty * i.price }));
      const { error: itemError } = await supabaseClient.from('order_items').insert(items);
      if (itemError) {
        console.error(itemError.message || itemError);
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        return;
      }

      // ‚úÖ ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠
      for (const item of cart) {
        const newStock = item.stock - item.qty;
        await supabaseClient
          .from('products')
          .update({ stock: newStock })
          .eq('id', item.id);
      }

      // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà stock = 0 ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ)
      await loadProducts();

      showSuccessPopup(order);
      cart = [];
      updateCart();
      clearOrderForm();
      toggleCart();
    }

    loadProducts();
    subscribeRealtimeProducts();

// ===== realtime products =====
function subscribeRealtimeProducts() {
  supabaseClient
    .channel('realtime-products')
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'products' },
      () => {
        loadProducts(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      }
    )
    .subscribe();
}

    function showSuccessPopup(order){
      const box=document.getElementById('popupDetail');
      box.innerHTML=`<div>‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: <b>${order.id}</b></div><div>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ‡∏ø${Number(order.total_amount).toLocaleString()}</div><div>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>`;
      document.getElementById('successPopup').style.display='flex';
    }
    function clearOrderForm(){
      document.getElementById('customerName').value='';
      document.getElementById('customerPhone').value='';
      document.getElementById('customerAddress').value='';
      document.getElementById('pickupBranch').value='';
      document.getElementById('pickupDate').value='';
      document.getElementById('pickupTime').value='';
      document.getElementById('slipFile').value='';
      const del = document.querySelector('input[name="delivery"][value="delivery"]');
      const pay = document.querySelector('input[name="payment"][value="transfer"]');
      if(del) del.checked=true;
      if(pay) pay.checked=true;
      toggleSlip(true);
    }
    function closePopup(){ document.getElementById('successPopup').style.display='none'; }

    // ===== ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ =====
    let currentDetailId = null;
    function openDetail(id){
      currentDetailId = id;
      const p = products.find(x=>x.id===id);
      if(!p) return;

      const images = (p.image_urls || []);
      const imageHtml = images.length
        ? images.map(u=>`<img src="${u}" style="width:120px;height:120px;object-fit:cover;border-radius:8px;cursor:pointer" onclick="openImageViewer('${u}')" />`).join('')
        : '<div style="color:#888">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>';

      const html = `
        <h2 style="margin-top:0">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
        <table style="width:100%;border-collapse:collapse;font-size:15px;">
          <tr><td style="padding:6px;border-bottom:1px solid #eee;width:40%">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td><td style="padding:6px;border-bottom:1px solid #eee">${p.name || '-'}</td></tr>
          <tr><td style="padding:6px;border-bottom:1px solid #eee">‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</td><td style="padding:6px;border-bottom:1px solid #eee">${p.brand || '-'}</td></tr>
          <tr><td style="padding:6px;border-bottom:1px solid #eee">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</td><td style="padding:6px;border-bottom:1px solid #eee">${p.category || '-'}</td></tr>
          <tr>
  <td style="padding:6px;border-bottom:1px solid #eee;vertical-align:top">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</td>
  <td style="padding:6px;border-bottom:1px solid #eee">
    <ul style="margin:0;padding-left:18px;line-height:1.7;">
      ${(p.brand_caption || '-').split('-').filter(t=>t.trim()).map(t=>`<li>${t.trim()}</li>`).join('')}
    </ul>
  </td>
</tr>
          <tr><td style="padding:6px;border-bottom:1px solid #eee">‡∏£‡∏≤‡∏Ñ‡∏≤</td><td style="padding:6px;border-bottom:1px solid #eee;color:#f53d2d;font-weight:bold">‡∏ø${Number(p.price).toLocaleString()}</td></tr>
        </table>

        <div style="margin-top:15px;">
          <div style="margin-bottom:6px;font-weight:bold">‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">${imageHtml}</div>
        </div>
      `;

      const box=document.getElementById('detailBox');
      box.innerHTML=html;
      document.getElementById('detailPopup').style.display='flex';
    }
    function closeDetail(){ document.getElementById('detailPopup').style.display='none'; }
    // ===== Slider ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ =====
    let currentSliderImages = [];
    let currentIndex = 0;

    function openSlider(productId){
      const p = products.find(x => x.id === productId);
      if(!p || !p.image_urls || p.image_urls.length===0) return;
      currentSliderImages = p.image_urls;
      currentIndex = 0;
      document.getElementById('sliderImg').src = currentSliderImages[0];
      document.getElementById('imageSlider').style.display='flex';
    }
    function nextSlide(e){ e.stopPropagation();
      currentIndex = (currentIndex+1) % currentSliderImages.length;
      document.getElementById('sliderImg').src = currentSliderImages[currentIndex];
    }
    function prevSlide(e){ e.stopPropagation();
      currentIndex = (currentIndex-1+currentSliderImages.length) % currentSliderImages.length;
      document.getElementById('sliderImg').src = currentSliderImages[currentIndex];
    }
    function closeSlider(){ document.getElementById('imageSlider').style.display='none'; }

    function openImageViewer(src){
      const viewer=document.getElementById('imageViewer');
      document.getElementById('viewerImg').src=src;
      // ‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î detailPopup ‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á
      viewer.style.display='flex';
    }
    function closeImageViewer(){ document.getElementById('imageViewer').style.display='none'; }
  </script>
</body>
</html>
